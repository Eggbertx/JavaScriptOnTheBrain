---
import path from "path";
import gamesListImport from "../../data/games.yaml";
import BaseLayout from "../../layouts/BaseLayout.astro";
import GameLinksBar from "../../components/GameLinksBar.astro";
import { fixLinks, prependBasePath } from "../../scripts/util";

const gamesList:GameListItem[] = gamesListImport.map(game => {
	if(!game.link) {
		throw new Error(`Game link is missing for game: ${game.name}`);
	}

	return {
		...game,
		link: prependBasePath(game.link),
		gameScripts: game.gameScripts?.map((script:RuntimeScript) => {
			if(!script.src) {
				throw new Error(`Game script source is missing for game: ${game.name}`);
			}
			return {
				...script,
				src: script.src
			};
		}),
		gameID: path.basename(game.link).replaceAll(".html", ""),
	}
});

export function getStaticPaths() {
	return gamesListImport.map(game => {
		return {
			params: { game: path.basename(game.link).replaceAll(".html", "") }
		};
	});
}

const activeGame:GameListItem|undefined = (gamesList as GameListItem[]).find(game => game.gameID === Astro.params.game);

if(!activeGame) {
	throw new Error(`Game not found: ${Astro.params.game}`);
}
const debug = import.meta.env.DEBUG_GAMES?true:false;
const gameInfoClass = activeGame.gameLinksHorizontal?"game-info hlinks":"game-info vlinks";
const originalPageURL = `http://www.javaonthebrain.com/java/${activeGame.link.substring(activeGame.link.lastIndexOf("/")+1)}`;

const usingOriginalInfo = !activeGame.newGamePageDescriptionHTML && activeGame.gamePageDescriptionHTML;
const infoClass = usingOriginalInfo ? "original-game-info" : "game-info";
---
<BaseLayout
	activePage={(activeGame?.gameID) ?? "games"}
	pageTitle={activeGame?.name}
	gameScripts={activeGame.gameScripts}
	hasTitleHeader={true}
	activeTab="Games"
	importMap={activeGame.importMap}>
		<p class="original-page"><a href={originalPageURL} target="_blank">Original page</a> </p>

		{debug && <script is:inline>
			window.debugGames = true;
		</script>}
		{(!activeGame.noStaticGameplayArea) &&
			<section class="gameplay-area"></section>}
		<section class={gameInfoClass}>
			<div class={infoClass} set:html={fixLinks(activeGame.newGamePageDescriptionHTML ?? activeGame.gamePageDescriptionHTML ?? "TODO")}>
			</div>
			{activeGame.gameLinks && 
				<GameLinksBar gameLinks={activeGame.gameLinks} isHorizontal={activeGame.gameLinksHorizontal} />
			}
		</section>
</BaseLayout>